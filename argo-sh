#!/usr/bin/env bash
set -euo pipefail

# ======================================================
# install-argo.sh
# Cloudflare Tunnel è‡ªåŠ¨å®‰è£…/å¸è½½è„šæœ¬
# ======================================================

die(){ echo -e "âœ– $*" >&2; exit 1; }
info(){ echo -e "â†’ $*"; }

# æ£€æŸ¥æ˜¯å¦ä¸º root
IS_ROOT=false
if [ "$(id -u)" -eq 0 ]; then
  IS_ROOT=true
fi

# å®šä¹‰é¢œè‰²
red='\033[0;31m'
green='\033[0;32m'
yellow='\033[1;33m'
cyan='\033[1;36m'
bold='\033[1m'
re='\033[0m'

cclear
echo -e "${cyan}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "        ğŸš€ Cloudflare Argo å®‰è£…/å¸è½½å™¨        "
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "${re}"

# èœå•ä¸»ä½“
echo -e "${bold}${green}1) å®‰è£… Argo Tunnel (å®‰è£…/é…ç½®)${re}"
echo -e "${bold}${red}2) å¸è½½ Argo Tunnel${re}"
echo -e "${bold}${yellow}3) é€€å‡ºè„šæœ¬${re}"
echo

# èœå•é€»è¾‘
while true;
do
  read -r -p "$(echo -e "${yellow}â†’ è¯·é€‰æ‹©æ“ä½œ (1/2/3): ${re}")" ACTION
  echo "DEBUG: ACTION is $ACTION"
  echo
  case "$ACTION" in
    1|2)
      break
      ;;
    3)
      echo -e "${green}ğŸ‘ æ„Ÿè°¢ä½¿ç”¨ Cloudflare Argo å®‰è£…/å¸è½½å™¨ï¼${re}" # <-- å¢åŠ æ­¤è¡Œ
      exit 0
      ;;
    *)
      echo -e "${red}âœ– æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 1ã€2 æˆ– 3ã€‚${re}"
      ;;
  esac
done


# ===============================================================
# å¸è½½é€»è¾‘ (ACTION == 2)
# ===============================================================
if [ "$ACTION" = "2" ]; then
  info "âš ï¸ å¼€å§‹å¸è½½ Cloudflare Argo Tunnel..."

  if $IS_ROOT; then
    SERVICE_FILE="/etc/systemd/system/cloudflared.service"
    CRED_DIR="/root/.cloudflared"
    BIN_PATH="/usr/local/bin/cloudflared"
    systemctl disable --now cloudflared 2>/dev/null || true
    rm -f "$SERVICE_FILE"
    systemctl daemon-reload || true
  else
    SERVICE_FILE="$HOME/.config/systemd/user/cloudflared.service"
    CRED_DIR="$HOME/.cloudflared"
    BIN_PATH="$HOME/.local/bin/cloudflared"
    systemctl --user disable --now cloudflared 2>/dev/null || true
    rm -f "$SERVICE_FILE"
    systemctl --user daemon-reload || true
  fi

  rm -rf "$CRED_DIR" "$BIN_PATH"
  echo
  info "âœ… å·²å¸è½½ Cloudflare Argo Tunnel"
  echo "  - æ¸…ç†äº†æœåŠ¡æ–‡ä»¶ã€å‡­è¯ç›®å½• ($CRED_DIR) å’ŒäºŒè¿›åˆ¶æ–‡ä»¶ ($BIN_PATH)"
  echo
  exit 0
fi

# ===============================================================
# å®‰è£…é€»è¾‘ (ACTION == 1)
# ===============================================================

# 1. å®‰è£…å¿…è¦å·¥å…·å’Œ cloudflared
info "ğŸ› ï¸ 1/4 å‡†å¤‡ç¯å¢ƒ..."
if [ -f /etc/alpine-release ]; then
  PKG_MGR="apk"
elif [ -f /etc/debian_version ]; then
  PKG_MGR="apt"
elif [ -f /etc/redhat-release ]; then
  PKG_MGR="yum"
else
  die "ä¸æ”¯æŒçš„ç³»ç»Ÿç±»å‹ã€‚"
fi

case "$PKG_MGR" in
  apk)
    apk add --no-cache curl wget >/dev/null 2>&1 || true ;;
  apt)
    apt update -y >/dev/null 2>&1 && apt install -y curl wget >/dev/null 2>&1 || true ;;
  yum)
    yum install -y curl wget >/dev/null 2>&1 || true ;;
esac

install_cloudflared(){
  if command -v cloudflared >/dev/null 2>&1; then
    info "cloudflared å·²å®‰è£…ã€‚"
    return
  fi
  info "æ­£åœ¨å®‰è£… cloudflared..."
  ARCH=$(uname -m)
  case "$ARCH" in
    x86_64|amd64)  FILE="cloudflared-linux-amd64" ;;
    aarch64|arm64) FILE="cloudflared-linux-arm64" ;;
    *) die "ä¸æ”¯æŒçš„æ¶æ„: $ARCH" ;;
  esac
		
  if $IS_ROOT; then
    DEST="/usr/local/bin"
  else
    DEST="$HOME/.local/bin"
    mkdir -p "$DEST"
    info "é root æ¨¡å¼ï¼šè¯·ç¡®ä¿ $DEST åœ¨ä½ çš„ PATH ç¯å¢ƒå˜é‡ä¸­ã€‚"
  fi

  wget -q -O "${DEST}/cloudflared" "https://github.com/cloudflare/cloudflared/releases/latest/download/${FILE}" || die "ä¸‹è½½ cloudflared å¤±è´¥"
  chmod +x "${DEST}/cloudflared"
  info "âœ… cloudflared å®‰è£…å®Œæˆåˆ° ${DEST}/cloudflared"
}
install_cloudflared

# ç¡®è®¤ cloudflared äºŒè¿›åˆ¶è·¯å¾„
CLOUD_BIN="$(command -v cloudflared)"
CF_VER="$("$CLOUD_BIN" --version 2>/dev/null | head -n1 | awk '{print $3}' || true)"
if [ -n "$CF_VER" ]; then
  info "æ£€æµ‹åˆ° cloudflared ç‰ˆæœ¬ï¼š$CF_VER"
fi
echo

# 2. é…ç½®è¾“å…¥
info "ğŸ“ 2/4 é…ç½®åŸŸåå’Œæ˜ å°„..."

if $IS_ROOT; then
  CRED_DIR="/root/.cloudflared"
else
  CRED_DIR="${HOME}/.cloudflared"
fi
CONFIG_FILE="$CRED_DIR/config.yml"
TOKEN_FILE="$CRED_DIR/token"
mkdir -p "$CRED_DIR"
chmod 700 "$CRED_DIR"

# è¾“å…¥åŸŸåæ•°é‡
while true; do
  read -r -p "éœ€è¦é…ç½®å¤šå°‘ä¸ªåŸŸå->ç«¯å£ï¼Ÿ(ä¾‹å¦‚ 2)ï¼š " NUM
  if [[ "$NUM" =~ ^[0-9]+$ ]] && [ "$NUM" -gt 0 ]; then
    break
  else
    echo -e "${red}âœ– è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼ˆå¿…é¡»å¤§äº 0ï¼‰ã€‚${re}"
  fi
done

MAPPINGS=""

for i in $(seq 1 "$NUM"); do
  echo
  echo "--- é…ç½®ç¬¬ $i ä¸ªåŸŸå ---"
		while true; do
				read -r -p "è¯·è¾“å…¥è¦ç»‘å®šçš„åŸŸåï¼ˆPublic Hostnameï¼‰ï¼š " DOMAIN
				if [[ -n "$DOMAIN" ]]; then
						break
				else
						echo -e "${red}âœ– åŸŸåä¸èƒ½ä¸ºç©ºï¼Œè¯·é‡æ–°è¾“å…¥ã€‚${re}"
				fi
		done
  read -r -p "è¯·è¾“å…¥æœ¬åœ°ç›‘å¬ç«¯å£ï¼ˆé»˜è®¤ 443ï¼‰ï¼š " PORT
  PORT=${PORT:-443}
  
		echo "è¯·é€‰æ‹©ä¼ è¾“æ–¹å¼ï¼š"
		echo "1) WebSocket (é»˜è®¤)"
		echo "2) gRPC"
		echo "3) TCP"
  read -r -p "é€‰æ‹©ä¼ è¾“ç±»å‹ (1/2/3ï¼Œé»˜è®¤ 1)ï¼š " STREAM_TYPE
  STREAM_TYPE=${STREAM_TYPE:-1}

  case "$STREAM_TYPE" in
    1)
      STREAM_TYPE="ws"
      read -r -p "è¯·è¾“å…¥ WebSocket è·¯å¾„ï¼ˆé»˜è®¤ /ï¼‰ï¼š " WS_PATH
      WS_PATH=${WS_PATH:-/}
      [[ "$WS_PATH" != /* ]] && WS_PATH="/$WS_PATH"
      ;;
    2)
      STREAM_TYPE="grpc"
      read -r -p "è¯·è¾“å…¥ gRPC ServiceNameï¼ˆé»˜è®¤ vmess-grpcï¼‰ï¼š " WS_PATH
      WS_PATH=${WS_PATH:-vmess-grpc}
      ;;
    3)
      STREAM_TYPE="tcp"
      WS_PATH="-"
      ;;
  esac
		
  read -r -p "è¯·è¾“å…¥åè®®ç±»å‹ (http/https/tcpï¼Œé»˜è®¤ http)ï¼š " PROTO
  PROTO=${PROTO:-http}
  case "$PROTO" in tcp|http|https) ;; *) PROTO="http" ;; esac
		MAPPINGS="${MAPPINGS}${DOMAIN},${PORT},${WS_PATH},${PROTO},${STREAM_TYPE}\n"
done

# 3. å‡­è¯è¾“å…¥
info "ğŸ”‘ 3/4 è¾“å…¥ Cloudflare å‡­è¯..."
MODE=${MODE:-1}
read -r -p "é€‰æ‹©å‡­è¯æ–¹å¼ (1: Token, 2: JSON æ–‡ä»¶å†…å®¹) é»˜è®¤ 1ï¼š " MODE

TUNNEL_TOKEN=""
CREDENTIAL_FILE=""

if [ "$MODE" = "1" ]; then
		while true; do
				read -r -p "è¯·è¾“å…¥ Cloudflare Tunnel Tokenï¼ˆä»¥ eyJ å¼€å¤´ï¼‰ï¼š " TUNNEL_TOKEN
				if [[ -n "$TUNNEL_TOKEN" ]]; then
						break
				else
						echo -e "${red}âœ– å¿…é¡»è¾“å…¥ Tokenï¼Œè¯·é‡æ–°è¾“å…¥ã€‚${re}"
				fi
		done
  printf "%s" "$TUNNEL_TOKEN" > "$TOKEN_FILE"
  chmod 600 "$TOKEN_FILE"
  info "âœ… Token å·²ä¿å­˜ï¼š$TOKEN_FILE"

else
  while true; do
    echo "è¯·è¾“å…¥ Cloudflare Tunnel credentials JSON å†…å®¹ï¼ˆç²˜è´´å®Œæ¯•åç›´æ¥æŒ‰å›è½¦ç¡®è®¤ï¼‰ï¼š"
    JSON_CONTENT=$(cat)
    if [[ -n "$JSON_CONTENT" ]]; then
        JSON_FILE_NAME="$(date +%Y%m%d-%H%M%S)-tunnel.json"
        CREDENTIAL_FILE="$CRED_DIR/$JSON_FILE_NAME"
        printf "%b" "$JSON_CONTENT" > "$CREDENTIAL_FILE"
        chmod 600 "$CREDENTIAL_FILE"
        info "âœ… å‡­è¯æ–‡ä»¶å·²ä¿å­˜ï¼š$CREDENTIAL_FILE"
        break
    else
        echo -e "${red}âœ– JSON å†…å®¹ä¸èƒ½ä¸ºç©ºï¼Œè¯·é‡æ–°è¾“å…¥ã€‚${re}"
    fi
  done
fi

# 4. ç”Ÿæˆ config.yml
info "ğŸ’¾ 4/4 ç”Ÿæˆé…ç½®æ–‡ä»¶ $CONFIG_FILE..."
{
  echo "# Cloudflare Tunnel Auto Generated"
  echo
  echo "ingress:"
  echo -e "$MAPPINGS" | while IFS=',' read -r HOST PORT PATH PROTO STREAM_TYPE; do
				[ -z "$HOST" ] && continue
				case "$PROTO" in
						tcp) SERVICE="tcp://localhost:${PORT}" ;;
						http|https) SERVICE="${PROTO}://localhost:${PORT}" ;;
				esac

				echo "  - hostname: ${HOST}"
				echo "    service: ${SERVICE}"
				echo "    originRequest:"
				echo "      noTLSVerify: true"
				echo "      httpHostHeader: ${HOST}"

				# WebSocket æ¨¡å¼æ·»åŠ å‡çº§å¤´
				if [ "$STREAM_TYPE" = "ws" ] && { [ "$PROTO" = "http" ] || [ "$PROTO" = "https" ]; }; then
						echo "      headers:"
						echo "        Connection: Upgrade"
						echo "        Upgrade: websocket"
				fi

				echo
		done
  echo "  - service: http_status:404"
} > "$CONFIG_FILE"
chmod 600 "$CONFIG_FILE"
info "âœ… é…ç½®æ–‡ä»¶å†™å…¥å®Œæˆã€‚"

# 5. systemd æœåŠ¡è®¾ç½®
info "âš™ï¸ å¯åŠ¨/å¯ç”¨ systemd æœåŠ¡..."

# ç¡®å®šå¯åŠ¨å‘½ä»¤ (å…¼å®¹æ–°æ—§ cloudflared)
USE_NEW_MODE=false
if "$CLOUD_BIN" tunnel run --help 2>&1 | grep -q -- '--token-file'; then
  USE_NEW_MODE=true
fi

if [ "$MODE" = "1" ]; then
  if [ "$USE_NEW_MODE" = true ]; then
    EXEC_CMD="$CLOUD_BIN tunnel run --token-file ${TOKEN_FILE}"
  else
    TOKEN_CONTENT="$(tr -d '\r\n' < "$TOKEN_FILE")"
    EXEC_CMD="$CLOUD_BIN tunnel run --token ${TOKEN_CONTENT} --config ${CONFIG_FILE}"
  fi
else
  if [ -n "${CREDENTIAL_FILE:-}" ] && [ -f "${CREDENTIAL_FILE}" ]; then
    EXEC_CMD="$CLOUD_BIN tunnel run --credentials-file ${CREDENTIAL_FILE}"
  else
    EXEC_CMD="$CLOUD_BIN tunnel run --config ${CONFIG_FILE}"
  fi
fi

if $IS_ROOT; then
  SERVICE_FILE="/etc/systemd/system/cloudflared.service"
  info "ç”Ÿæˆ systemd æœåŠ¡æ–‡ä»¶ï¼ˆsystemï¼‰: $SERVICE_FILE"
  cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Cloudflare Tunnel Service
After=network-online.target

[Service]
Type=simple
ExecStart=${EXEC_CMD}
Restart=on-failure
RestartSec=5s
User=root
WorkingDirectory=${CRED_DIR}

[Install]
WantedBy=multi-user.target
EOF

  systemctl daemon-reload
  systemctl enable --now cloudflared || true
  
  sleep 2
  if systemctl is-active --quiet cloudflared; then
    info "âœ… cloudflared system service å¯åŠ¨æˆåŠŸ"
  else
   die "Cloudflare å¯åŠ¨å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—ï¼šjournalctl -u cloudflared -n 50 --no-pager"
  fi

else
  # é rootï¼šåˆ›å»ºç”¨æˆ·çº§ systemd å•å…ƒ
  USER_SERVICE_DIR="${HOME}/.config/systemd/user"
  mkdir -p "$USER_SERVICE_DIR"
  SERVICE_FILE="${USER_SERVICE_DIR}/cloudflared.service"
  info "ç”Ÿæˆ systemd ç”¨æˆ·æœåŠ¡æ–‡ä»¶ï¼ˆuserï¼‰: $SERVICE_FILE"
  cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Cloudflare Tunnel Service (user)
After=network-online.target

[Service]
Type=simple
ExecStart=${EXEC_CMD}
Restart=on-failure
RestartSec=5s
WorkingDirectory=${CRED_DIR}

[Install]
WantedBy=default.target
EOF

  systemctl --user daemon-reload || true
  systemctl --user enable --now cloudflared || true
  sleep 1
  if systemctl --user is-active --quiet cloudflared; then
    info "âœ… cloudflared ç”¨æˆ·æœåŠ¡å¯åŠ¨æˆåŠŸ (systemd --user)"
    echo "ğŸ‘ é root ç”¨æˆ·æ³¨æ„ï¼šå»ºè®®æ‰§è¡Œ 'loginctl enable-linger \$USER' ä»¥ç¡®ä¿æœåŠ¡éšç³»ç»Ÿé‡å¯ã€‚"
  else
    die "ç”¨æˆ·æœåŠ¡å¯åŠ¨å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—ï¼šjournalctl --user -u cloudflared -n 50 --no-pager"
  fi
fi

# æœ€ç»ˆç¡®è®¤ä¿¡æ¯
echo
echo -e "${green}=========================================="
echo -e "âœ… å®‰è£…å¹¶å¯åŠ¨å®Œæˆï¼"
echo -e "=========================================="
echo "é…ç½®è·¯å¾„: ${CONFIG_FILE}"
echo "æ—¥å¿—æŸ¥çœ‹: $(if $IS_ROOT; then echo "journalctl -u cloudflared -f"; else echo "journalctl --user -u cloudflared -f"; fi)"
echo "é‡å¯æœåŠ¡: $(if $IS_ROOT; then echo "systemctl restart cloudflared"; else echo "systemctl --user restart cloudflared"; fi)"
echo -e "${re}"